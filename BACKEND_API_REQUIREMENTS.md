# –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ API –¥–ª—è —Ç–∞–±–ª–∏—Ü —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π

## –ü—Ä–æ–±–ª–µ–º–∞

–ë—ç–∫–µ–Ω–¥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ PBF —Ç–∞–π–ª—ã:

```
GET /api/v1/address/clickhouse/building-risk-tile/{z}/{x}/{y}.pbf?measure_category=CATEGORY
```

–ù–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ **—Ç–∞–±–ª–∏—Ü–∞—Ö** –Ω—É–∂–µ–Ω JSON API endpoint, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–¥–∞–Ω–∏–π (–Ω–µ –ø–æ —Ç–∞–π–ª–∞–º).

## –¢—Ä–µ–±—É–µ–º—ã–π endpoint

```http
GET /api/v1/address/clickhouse/building-risk
```

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:

| –ü–∞—Ä–∞–º–µ—Ç—Ä           | –¢–∏–ø    | –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π | –û–ø–∏—Å–∞–Ω–∏–µ                                                    |
| ------------------ | ------ | ------------ | ----------------------------------------------------------- |
| `measure_category` | string | –î–∞           | –ö–∞—Ç–µ–≥–æ—Ä–∏—è: `demolition`, `passportization`, `strengthening` |
| `district`         | string | –ù–µ—Ç          | –†–∞–π–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ê–ª–º–∞–ª–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω")                       |

### –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤:

```http
GET /building-risk?measure_category=demolition
GET /building-risk?measure_category=strengthening&district=–ê–ª–º–∞–ª–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω
GET /building-risk?measure_category=passportization
```

## –¢—Ä–µ–±—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞

JSON –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤:

```json
[
  {
    "id": 123,
    "building_id": "BLD001",
    "address": "—É–ª. –ê–±–∞—è, 10",
    "district": "–ê–ª–º–∞–ª–∏–Ω—Å–∫–∏–π —Ä–∞–π–æ–Ω",
    "sri": 0.15,
    "h": 0.85,
    "v": 0.72,
    "e": 0.68
  },
  {
    "id": 124,
    "building_id": "BLD002",
    "address": "–ø—Ä. –ù–∞–∑–∞—Ä–±–∞–µ–≤–∞, 45",
    "district": "–ú–µ–¥–µ—É—Å–∫–∏–π —Ä–∞–π–æ–Ω",
    "sri": 0.42,
    "h": 0.58,
    "v": 0.51,
    "e": 0.45
  }
]
```

## –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è

| –ü–æ–ª–µ          | –¢–∏–ø           | –û–ø–∏—Å–∞–Ω–∏–µ                         |
| ------------- | ------------- | -------------------------------- |
| `id`          | number/string | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–∞–ø–∏—Å–∏             |
| `building_id` | string        | ID –∑–¥–∞–Ω–∏—è                        |
| `address`     | string        | –ê–¥—Ä–µ—Å –∑–¥–∞–Ω–∏—è                     |
| `district`    | string        | –†–∞–π–æ–Ω                            |
| `sri`         | number        | Seismic Risk Index (0-1)         |
| `h`           | number        | Hazard - –æ–ø–∞—Å–Ω–æ—Å—Ç—å (0-1)         |
| `v`           | number        | Vulnerability - —É—è–∑–≤–∏–º–æ—Å—Ç—å (0-1) |
| `e`           | number        | Exposure - —ç–∫—Å–ø–æ–∑–∏—Ü–∏—è (0-1)      |

## üî¥ –ö–†–ò–¢–ò–ß–ù–û: CORS

### –ü—Ä–æ–±–ª–µ–º–∞

**–í–°–ï –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è CORS –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤!**

```
Access to fetch at 'https://admin.smartalmaty.kz/api/v1/address/clickhouse/building-risk-tile/...'
from origin 'http://localhost:3000' has been blocked by CORS policy:
No 'Access-Control-Allow-Origin' header is present on the requested resource.
```

### –†–µ—à–µ–Ω–∏–µ

–ë—ç–∫–µ–Ω–¥ –¥–æ–ª–∂–µ–Ω –¥–æ–±–∞–≤–∏—Ç—å CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–æ **–í–°–ï–ú** –æ—Ç–≤–µ—Ç–∞–º (–≤–∫–ª—é—á–∞—è PBF —Ç–∞–π–ª—ã):

**–î–ª—è development:**

```
Access-Control-Allow-Origin: http://localhost:3000
Access-Control-Allow-Methods: GET, OPTIONS
Access-Control-Allow-Headers: Content-Type
```

**–î–ª—è production (–ø—Ä–æ—â–µ):**

```
Access-Control-Allow-Origin: *
```

### –ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å –∏–∑-–∑–∞ CORS:

- ‚ùå –ö–∞—Ä—Ç–∞ –ø—É—Å—Ç–∞—è (—Ç–∞–π–ª—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è)
- ‚ùå –¢–∞–±–ª–∏—Ü—ã –ø—É—Å—Ç—ã–µ (JSON API –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç + CORS)
- ‚ùå –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç CORS error

### –≠—Ç–æ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫:

1. `/building-risk-tile/{z}/{x}/{y}.pbf` - PBF —Ç–∞–π–ª—ã –¥–ª—è –∫–∞—Ä—Ç—ã
2. `/building-risk` - JSON API –¥–ª—è —Ç–∞–±–ª–∏—Ü (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω)

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### Pagination (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –∑–¥–∞–Ω–∏–π –º–Ω–æ–≥–æ, –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞–≥–∏–Ω–∞—Ü–∏—é:

```http
GET /building-risk?measure_category=demolition&page=1&page_size=100
```

–û—Ç–≤–µ—Ç:

```json
{
  "data": [...],
  "total": 1543,
  "page": 1,
  "page_size": 100,
  "total_pages": 16
}
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞

–ï—Å–ª–∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ endpoint —Å–ª–æ–∂–Ω–æ, –º–æ–∂–Ω–æ:

1. –î–æ–±–∞–≤–∏—Ç—å endpoint –∫–æ—Ç–æ—Ä—ã–π –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ PBF —Ç–∞–π–ª—ã –≤ JSON
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ö–∞–Ω–∏–∑–º, –Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å GeoJSON:

```http
GET /building-risk-geojson?measure_category=demolition
```

–û—Ç–≤–µ—Ç (GeoJSON Feature Collection):

```json
{
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "geometry": { "type": "Point", "coordinates": [76.9, 43.2] },
      "properties": {
        "id": 123,
        "address": "—É–ª. –ê–±–∞—è, 10",
        "sri": 0.15,
        "h": 0.85,
        "v": 0.72,
        "e": 0.68
      }
    }
  ]
}
```

## ‚ö†Ô∏è –¢–µ–∫—É—â–∏–π –°—Ç–∞—Ç—É—Å

### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:

- üî¥ **CORS –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω** - –í–°–ï –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º!
- ‚ùå **JSON API –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** - endpoint `/building-risk` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 502
- ‚ùå **–ö–∞—Ä—Ç–∞ –ü–£–°–¢–ê–Ø** - —Ç–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, –Ω–æ –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è CORS
- ‚ùå **–¢–∞–±–ª–∏—Ü—ã –ü–£–°–¢–´–ï** - –Ω–µ—Ç JSON API + CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

- ‚úÖ PBF —Ç–∞–π–ª—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Å—É–¥—è –ø–æ 502, –∞ –Ω–µ 404)
- ‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∫–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üö® –°—Ä–æ—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS (–ö–†–ò–¢–ò–ß–ù–û!)

–î–æ–±–∞–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫ `/building-risk-tile/**` endpoints:

```nginx
add_header 'Access-Control-Allow-Origin' '*';
add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
add_header 'Access-Control-Allow-Headers' 'Content-Type';
```

–ë–µ–∑ —ç—Ç–æ–≥–æ **–Ω–∏—á–µ–≥–æ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å** –≤ development!

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –°–æ–∑–¥–∞—Ç—å JSON API

–°–æ–∑–¥–∞—Ç—å endpoint `/building-risk` –¥–ª—è —Ç–∞–±–ª–∏—Ü:

- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `measure_category`
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `district` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏: `address`, `sri`, `h`, `v`, `e`

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS** - —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É –∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã
2. ‚úÖ **–°–æ–∑–¥–∞—Ç—å JSON API** - –∑–∞–ø–æ–ª–Ω–∏—Ç —Ç–∞–±–ª–∏—Ü—ã –¥–∞–Ω–Ω—ã–º–∏
3. ‚úÖ **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å** —á—Ç–æ –ø–æ–ª—è `address`, `sri`, `h`, `e`, `v` –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è
